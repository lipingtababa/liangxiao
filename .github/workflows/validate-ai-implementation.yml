name: éªŒè¯AIå®žçŽ°

on:
  workflow_dispatch:
  push:
    paths:
      - 'scripts/*.py'
      
jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install requests beautifulsoup4 googletrans==4.0.0-rc1
        
    - name: æµ‹è¯•å†…å®¹æå–å™¨
      id: test_extractor
      run: |
        echo "=== æµ‹è¯•å†…å®¹æå–å™¨ ==="
        
        # æŸ¥æ‰¾æå–å™¨è„šæœ¬
        EXTRACTOR=""
        for script in scripts/extract_content.py scripts/extract_content_starter.py; do
          if [ -f "$script" ]; then
            EXTRACTOR="$script"
            break
          fi
        done
        
        if [ -z "$EXTRACTOR" ]; then
          echo "âŒ æ‰¾ä¸åˆ°æå–å™¨è„šæœ¬"
          exit 1
        fi
        
        echo "ä½¿ç”¨è„šæœ¬: $EXTRACTOR"
        
        # ä½¿ç”¨mockæ•°æ®æµ‹è¯•
        python "$EXTRACTOR" --mock --output test_extract.json
        
        # éªŒè¯è¾“å‡º
        if [ -f "test_extract.json" ]; then
          echo "âœ“ ç”Ÿæˆäº†è¾“å‡ºæ–‡ä»¶"
          
          # æ£€æŸ¥å¿…éœ€å­—æ®µ
          python -c "
import json
with open('test_extract.json') as f:
    data = json.load(f)
    
required = ['title', 'author', 'content']
missing = [f for f in required if not data.get(f)]

if missing:
    print(f'âŒ ç¼ºå°‘å­—æ®µ: {missing}')
    exit(1)
else:
    print('âœ“ æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨')
    print(f'  æ ‡é¢˜: {data.get(\"title\", \"\")}')
    print(f'  ä½œè€…: {data.get(\"author\", \"\")}')
    print(f'  å†…å®¹é•¿åº¦: {len(data.get(\"content\", {}).get(\"text\", \"\"))} å­—ç¬¦')
          "
        else
          echo "âŒ æ²¡æœ‰ç”Ÿæˆè¾“å‡ºæ–‡ä»¶"
          exit 1
        fi
        
    - name: æµ‹è¯•ç¿»è¯‘å™¨
      id: test_translator
      continue-on-error: true
      run: |
        echo "=== æµ‹è¯•ç¿»è¯‘å™¨ ==="
        
        # æŸ¥æ‰¾ç¿»è¯‘å™¨è„šæœ¬
        TRANSLATOR=""
        for script in scripts/translate.py scripts/translate_content.py; do
          if [ -f "$script" ]; then
            TRANSLATOR="$script"
            break
          fi
        done
        
        if [ -z "$TRANSLATOR" ]; then
          echo "âš  ç¿»è¯‘å™¨è„šæœ¬æœªå®žçŽ°"
        else
          echo "ä½¿ç”¨è„šæœ¬: $TRANSLATOR"
          
          # æµ‹è¯•ç¿»è¯‘
          if [ -f "test_extract.json" ]; then
            python "$TRANSLATOR" --input test_extract.json --output test_translate.json || {
              echo "âš  ç¿»è¯‘å™¨æ‰§è¡Œå¤±è´¥ï¼ˆå¯èƒ½æ˜¯APIå¯†é’¥é—®é¢˜ï¼‰"
            }
            
            if [ -f "test_translate.json" ]; then
              echo "âœ“ ç¿»è¯‘å™¨ç”Ÿæˆäº†è¾“å‡º"
            fi
          fi
        fi
        
    - name: æµ‹è¯•Markdownç”Ÿæˆå™¨
      id: test_generator
      continue-on-error: true
      run: |
        echo "=== æµ‹è¯•Markdownç”Ÿæˆå™¨ ==="
        
        # æŸ¥æ‰¾ç”Ÿæˆå™¨è„šæœ¬
        GENERATOR=""
        for script in scripts/generate_markdown.py scripts/markdown_generator.py; do
          if [ -f "$script" ]; then
            GENERATOR="$script"
            break
          fi
        done
        
        if [ -z "$GENERATOR" ]; then
          echo "âš  Markdownç”Ÿæˆå™¨æœªå®žçŽ°"
        else
          echo "ä½¿ç”¨è„šæœ¬: $GENERATOR"
          
          # ä½¿ç”¨æå–çš„æ•°æ®ç”ŸæˆMarkdown
          INPUT_FILE="test_translate.json"
          if [ ! -f "$INPUT_FILE" ]; then
            INPUT_FILE="test_extract.json"
          fi
          
          if [ -f "$INPUT_FILE" ]; then
            mkdir -p test_output
            python "$GENERATOR" --input "$INPUT_FILE" --output test_output/ || {
              echo "âš  ç”Ÿæˆå™¨æ‰§è¡Œå¤±è´¥"
            }
            
            # æ£€æŸ¥è¾“å‡º
            if ls test_output/*.md 1> /dev/null 2>&1; then
              echo "âœ“ ç”Ÿæˆäº†Markdownæ–‡ä»¶"
              echo "æ–‡ä»¶åˆ—è¡¨:"
              ls -la test_output/*.md
            fi
          fi
        fi
        
    - name: ç»¼åˆè¯„åˆ†
      if: always()
      run: |
        echo "=== AIå®žçŽ°è¯„åˆ† ==="
        
        SCORE=0
        MAX_SCORE=100
        
        # å†…å®¹æå–å™¨ (40åˆ†)
        if [ -f "test_extract.json" ]; then
          python -c "
import json
score = 0
with open('test_extract.json') as f:
    data = json.load(f)
    if data.get('title'): score += 15
    if data.get('author'): score += 10
    if data.get('content', {}).get('text'): score += 10
    if data.get('images'): score += 5
print(score)
          " > extractor_score.txt
          EXTRACTOR_SCORE=$(cat extractor_score.txt)
          SCORE=$((SCORE + EXTRACTOR_SCORE))
          echo "å†…å®¹æå–å™¨: ${EXTRACTOR_SCORE}/40 åˆ†"
        else
          echo "å†…å®¹æå–å™¨: 0/40 åˆ†"
        fi
        
        # ç¿»è¯‘å™¨ (30åˆ†)
        if [ -f "test_translate.json" ]; then
          SCORE=$((SCORE + 30))
          echo "ç¿»è¯‘å™¨: 30/30 åˆ†"
        else
          echo "ç¿»è¯‘å™¨: 0/30 åˆ†ï¼ˆæœªå®žçŽ°æˆ–APIå¯†é’¥ç¼ºå¤±ï¼‰"
        fi
        
        # Markdownç”Ÿæˆå™¨ (30åˆ†)
        if ls test_output/*.md 1> /dev/null 2>&1; then
          SCORE=$((SCORE + 30))
          echo "Markdownç”Ÿæˆå™¨: 30/30 åˆ†"
        else
          echo "Markdownç”Ÿæˆå™¨: 0/30 åˆ†"
        fi
        
        echo ""
        echo "æ€»åˆ†: ${SCORE}/${MAX_SCORE}"
        
        # è¯„çº§
        if [ $SCORE -ge 90 ]; then
          echo "è¯„çº§: ðŸŒŸ ä¼˜ç§€ - å®žçŽ°å®Œæ•´ä¸”æ­£ç¡®"
        elif [ $SCORE -ge 70 ]; then
          echo "è¯„çº§: âœ… è‰¯å¥½ - ä¸»è¦åŠŸèƒ½å·²å®žçŽ°"
        elif [ $SCORE -ge 40 ]; then
          echo "è¯„çº§: ðŸ“ åŠæ ¼ - åŸºç¡€åŠŸèƒ½å¯ç”¨"
        else
          echo "è¯„çº§: âš ï¸ éœ€è¦æ”¹è¿› - è¯·ç»§ç»­å®Œæˆå®žçŽ°"
        fi
        
        # GitHub Actions æ‘˜è¦
        echo "## AIå®žçŽ°éªŒè¯ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å¾—åˆ†: ${SCORE}/${MAX_SCORE}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ç»„ä»¶ | çŠ¶æ€ | å¾—åˆ† |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "test_extract.json" ]; then
          echo "| å†…å®¹æå–å™¨ | âœ… å·²å®žçŽ° | ${EXTRACTOR_SCORE}/40 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| å†…å®¹æå–å™¨ | âŒ æœªå®Œæˆ | 0/40 |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "test_translate.json" ]; then
          echo "| ç¿»è¯‘å™¨ | âœ… å·²å®žçŽ° | 30/30 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ç¿»è¯‘å™¨ | âš ï¸ æœªå®žçŽ° | 0/30 |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if ls test_output/*.md 1> /dev/null 2>&1; then
          echo "| Markdownç”Ÿæˆå™¨ | âœ… å·²å®žçŽ° | 30/30 |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Markdownç”Ÿæˆå™¨ | âš ï¸ æœªå®žçŽ° | 0/30 |" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ai-validation-results
        path: |
          test_*.json
          test_output/
          *_score.txt
        retention-days: 7