name: éªŒæ”¶æµ‹è¯• (Acceptance Tests)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.9'

jobs:
  acceptance-tests:
    name: è¿è¡ŒBDDéªŒæ”¶æµ‹è¯•
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-suite:
          - extraction
          - translation
          - publishing
          - e2e

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£… Node.js ä¾èµ–
        run: |
          npm ci
          npx playwright install chromium

      - name: ðŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ—‚ï¸ åˆ›å»ºæµ‹è¯•ç›®å½•
        run: |
          mkdir -p test-results
          mkdir -p test-results/screenshots
          mkdir -p test-results/data
          mkdir -p posts
          mkdir -p public/images

      - name: ðŸ—ï¸ æž„å»ºåº”ç”¨
        run: npm run build

      - name: ðŸš€ å¯åŠ¨åº”ç”¨æœåŠ¡å™¨
        run: |
          npm start &
          sleep 5
          curl -I http://localhost:3000 || exit 1
        env:
          NODE_ENV: test

      - name: ðŸ§ª è¿è¡ŒéªŒæ”¶æµ‹è¯• - ${{ matrix.test-suite }}
        run: |
          if [ "${{ matrix.test-suite }}" = "extraction" ]; then
            npm run test:acceptance -- --tags "@extraction or not @wip" features/01_article_extraction.feature
          elif [ "${{ matrix.test-suite }}" = "translation" ]; then
            npm run test:acceptance -- --tags "@translation or not @wip" features/02_translation.feature
          elif [ "${{ matrix.test-suite }}" = "publishing" ]; then
            npm run test:acceptance -- --tags "@publishing or not @wip" features/03_publishing.feature
          elif [ "${{ matrix.test-suite }}" = "e2e" ]; then
            npm run test:acceptance -- --tags "@e2e or @critical" features/04_end_to_end_workflow.feature
          fi
        env:
          BASE_URL: http://localhost:3000
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          HEADLESS: true

      - name: ðŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          if [ -f test-results/cucumber-report.json ]; then
            npx cucumber-html-reporter --input test-results/cucumber-report.json --output test-results/cucumber-report.html
          fi

      - name: ðŸ“¸ ä¸Šä¼ æµ‹è¯•ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: acceptance-test-results-${{ matrix.test-suite }}
          path: |
            test-results/
          retention-days: 7

      - name: ðŸ“¸ ä¸Šä¼ å¤±è´¥æˆªå›¾
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: failure-screenshots-${{ matrix.test-suite }}
          path: |
            test-results/screenshots/
          retention-days: 3

  test-summary:
    name: æµ‹è¯•æ±‡æ€»
    runs-on: ubuntu-latest
    needs: acceptance-tests
    if: always()

    steps:
      - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æžœ
        uses: actions/download-artifact@v3
        with:
          path: all-test-results

      - name: ðŸ“Š ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        run: |
          echo "# éªŒæ”¶æµ‹è¯•æ±‡æ€»æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æµ‹è¯•å¥—ä»¶ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for suite in extraction translation publishing e2e; do
            if [ -d "all-test-results/acceptance-test-results-$suite" ]; then
              echo "- âœ… $suite: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ $suite: å¤±è´¥æˆ–æœªè¿è¡Œ" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šè¯·ä¸‹è½½ artifacts" >> $GITHUB_STEP_SUMMARY