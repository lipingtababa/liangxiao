name: è‡ªåŠ¨å¤„ç†æ–‡ç« 

# å½“articles.txtæ–‡ä»¶å‘ç”Ÿå˜æ›´æ—¶è§¦å‘
on:
  push:
    branches:
      - main
      - feature/**
    paths:
      - 'articles.txt'
  workflow_dispatch:
    inputs:
      force_process:
        description: 'å¼ºåˆ¶å¤„ç†æ‰€æœ‰æ–‡ç« '
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  process-articles:
    name: å¤„ç†æ–‡ç« å˜æ›´
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä»¥ä¾¿æ¯”è¾ƒ

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. ç¼“å­˜Pythonä¾èµ–
      - name: ç¼“å­˜Pythonä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. å®‰è£…Pythonä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 5. æ£€æµ‹æ–‡ç« å˜æ›´
      - name: æ£€æµ‹æ–‡ç« å˜æ›´
        id: detect_changes
        run: |
          echo "## æ£€æµ‹articles.txtå˜æ›´"

          # å¦‚æœæ˜¯å¼ºåˆ¶å¤„ç†ï¼Œå¤„ç†æ‰€æœ‰æ–‡ç« 
          if [ "${{ github.event.inputs.force_process }}" == "true" ]; then
            echo "å¼ºåˆ¶å¤„ç†æ¨¡å¼ï¼šå°†å¤„ç†æ‰€æœ‰æ–‡ç« "
            cp articles.txt articles_to_process.txt
            echo "articles_count=$(wc -l < articles_to_process.txt)" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # è·å–å˜æ›´çš„URL
            if [ "${{ github.event_name }}" == "push" ]; then
              # æ¯”è¾ƒå½“å‰ç‰ˆæœ¬å’Œä¸Šä¸€ä¸ªç‰ˆæœ¬çš„articles.txt
              git diff HEAD~1 HEAD -- articles.txt > diff.txt || true

              # æå–æ–°å¢çš„URL
              grep "^+" diff.txt | grep "^+http" | sed 's/^+//' > articles_to_process.txt || true

              if [ -s articles_to_process.txt ]; then
                echo "å‘ç°æ–°å¢æ–‡ç« URL:"
                cat articles_to_process.txt
                echo "articles_count=$(wc -l < articles_to_process.txt)" >> $GITHUB_OUTPUT
                echo "has_changes=true" >> $GITHUB_OUTPUT
              else
                echo "æ²¡æœ‰æ–°å¢æ–‡ç« "
                echo "articles_count=0" >> $GITHUB_OUTPUT
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "æ‰‹åŠ¨è§¦å‘ï¼šå°†å¤„ç†æ‰€æœ‰æ–‡ç« "
              cp articles.txt articles_to_process.txt
              echo "articles_count=$(wc -l < articles_to_process.txt)" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi

      # 6. å¤„ç†æ–‡ç« ï¼ˆæå–å†…å®¹ï¼‰
      - name: æå–æ–‡ç« å†…å®¹
        if: steps.detect_changes.outputs.has_changes == 'true'
        id: extract
        run: |
          echo "## å¼€å§‹æå–æ–‡ç« å†…å®¹"

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p extracted_articles

          # å¤„ç†æ¯ä¸ªURL
          while IFS= read -r url || [ -n "$url" ]; do
            if [ -n "$url" ] && [ "$url" != "" ]; then
              echo "å¤„ç†: $url"

              # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆä½¿ç”¨URLçš„MD5ä½œä¸ºæ–‡ä»¶åï¼‰
              filename=$(echo -n "$url" | md5sum | cut -d' ' -f1)
              output_file="extracted_articles/${filename}.json"

              # è¿è¡Œæå–è„šæœ¬
              python scripts/extract_content_starter.py \
                --url "$url" \
                --output "$output_file" || {
                echo "::warning::æå–å¤±è´¥: $url"
                continue
              }

              echo "âœ“ æå–æˆåŠŸ: $output_file"
            fi
          done < articles_to_process.txt

          # ç»Ÿè®¡æˆåŠŸæå–çš„æ–‡ç« æ•°
          extracted_count=$(ls extracted_articles/*.json 2>/dev/null | wc -l || echo 0)
          echo "extracted_count=$extracted_count" >> $GITHUB_OUTPUT

          if [ "$extracted_count" -gt 0 ]; then
            echo "æˆåŠŸæå– $extracted_count ç¯‡æ–‡ç« "
            echo "extraction_success=true" >> $GITHUB_OUTPUT
          else
            echo "::error::æ²¡æœ‰æˆåŠŸæå–ä»»ä½•æ–‡ç« "
            echo "extraction_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # 7. ç¿»è¯‘æ–‡ç« 
      - name: ç¿»è¯‘æ–‡ç« 
        if: steps.extract.outputs.extraction_success == 'true'
        id: translate
        run: |
          echo "## å¼€å§‹ç¿»è¯‘æ–‡ç« "

          # åˆ›å»ºç¿»è¯‘è¾“å‡ºç›®å½•
          mkdir -p translated_articles

          # æ£€æŸ¥æ˜¯å¦æœ‰ç¿»è¯‘è„šæœ¬
          if [ -f "scripts/translate_article.py" ]; then
            # ç¿»è¯‘æ¯ä¸ªæå–çš„æ–‡ç« 
            for json_file in extracted_articles/*.json; do
              if [ -f "$json_file" ]; then
                echo "ç¿»è¯‘: $json_file"

                # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
                basename=$(basename "$json_file" .json)
                output_file="translated_articles/${basename}_translated.json"

                # è¿è¡Œç¿»è¯‘è„šæœ¬
                python scripts/translate_article.py \
                  --input "$json_file" \
                  --output "$output_file" || {
                  echo "::warning::ç¿»è¯‘å¤±è´¥: $json_file"
                  continue
                }

                echo "âœ“ ç¿»è¯‘æˆåŠŸ: $output_file"
              fi
            done
          else
            echo "::warning::ç¿»è¯‘è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¿»è¯‘æ­¥éª¤"
            # ç›´æ¥å¤åˆ¶æå–çš„æ–‡ä»¶ä½œä¸º"ç¿»è¯‘"ç»“æœ
            cp -r extracted_articles/* translated_articles/ 2>/dev/null || true
          fi

          # ç»Ÿè®¡ç¿»è¯‘æˆåŠŸçš„æ–‡ç« æ•°
          translated_count=$(ls translated_articles/*.json 2>/dev/null | wc -l || echo 0)
          echo "translated_count=$translated_count" >> $GITHUB_OUTPUT

          if [ "$translated_count" -gt 0 ]; then
            echo "æˆåŠŸç¿»è¯‘ $translated_count ç¯‡æ–‡ç« "
            echo "translation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::æ²¡æœ‰æˆåŠŸç¿»è¯‘ä»»ä½•æ–‡ç« ï¼Œä½¿ç”¨åŸå§‹å†…å®¹"
            echo "translation_success=false" >> $GITHUB_OUTPUT
          fi

      # 8. ç”ŸæˆMarkdownæ–‡ä»¶
      - name: ç”ŸæˆMarkdownæ–‡ä»¶
        if: steps.extract.outputs.extraction_success == 'true'
        id: generate_markdown
        run: |
          echo "## ç”ŸæˆMarkdownæ–‡ä»¶"

          # åˆ›å»ºpostsç›®å½•
          mkdir -p app/posts

          # æ£€æŸ¥æ˜¯å¦æœ‰Markdownç”Ÿæˆè„šæœ¬
          if [ -f "scripts/generate_markdown.py" ]; then
            # é€‰æ‹©è¾“å…¥ç›®å½•ï¼ˆä¼˜å…ˆä½¿ç”¨ç¿»è¯‘åçš„æ–‡ç« ï¼‰
            if [ -d "translated_articles" ] && [ "$(ls -A translated_articles)" ]; then
              input_dir="translated_articles"
            else
              input_dir="extracted_articles"
            fi

            # ä¸ºæ¯ä¸ªJSONæ–‡ä»¶ç”ŸæˆMarkdown
            for json_file in $input_dir/*.json; do
              if [ -f "$json_file" ]; then
                echo "ç”ŸæˆMarkdown: $json_file"

                # è¿è¡ŒMarkdownç”Ÿæˆè„šæœ¬
                python scripts/generate_markdown.py \
                  --input "$json_file" \
                  --output-dir "app/posts" || {
                  echo "::warning::Markdownç”Ÿæˆå¤±è´¥: $json_file"
                  continue
                }

                echo "âœ“ Markdownç”ŸæˆæˆåŠŸ"
              fi
            done
          else
            echo "::warning::Markdownç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨ï¼Œåˆ›å»ºç®€å•çš„Markdownæ–‡ä»¶"

            # åˆ›å»ºç®€å•çš„Markdownæ–‡ä»¶
            for json_file in extracted_articles/*.json; do
              if [ -f "$json_file" ]; then
                # æå–åŸºæœ¬ä¿¡æ¯å¹¶åˆ›å»ºç®€å•çš„Markdown
                title=$(python -c "import json; print(json.load(open('$json_file'))['title'])" 2>/dev/null || echo "æ— æ ‡é¢˜")
                content=$(python -c "import json; print(json.load(open('$json_file'))['content']['text'])" 2>/dev/null || echo "æ— å†…å®¹")
                date=$(date +%Y-%m-%d)
                basename=$(basename "$json_file" .json)

                cat > "app/posts/${basename}.md" << EOF
---
title: "$title"
date: "$date"
author: "ç‘å…¸é©¬å·¥"
---

$content
EOF
                echo "âœ“ åˆ›å»ºMarkdown: app/posts/${basename}.md"
              fi
            done
          fi

          # ç»Ÿè®¡ç”Ÿæˆçš„Markdownæ–‡ä»¶æ•°
          markdown_count=$(ls app/posts/*.md 2>/dev/null | wc -l || echo 0)
          echo "markdown_count=$markdown_count" >> $GITHUB_OUTPUT

          if [ "$markdown_count" -gt 0 ]; then
            echo "æˆåŠŸç”Ÿæˆ $markdown_count ä¸ªMarkdownæ–‡ä»¶"
            echo "markdown_success=true" >> $GITHUB_OUTPUT
          else
            echo "::error::æ²¡æœ‰ç”Ÿæˆä»»ä½•Markdownæ–‡ä»¶"
            echo "markdown_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # 9. æäº¤å˜æ›´
      - name: æäº¤ç”Ÿæˆçš„æ–‡ä»¶
        if: steps.generate_markdown.outputs.markdown_success == 'true'
        id: commit
        run: |
          echo "## æäº¤å˜æ›´"

          # é…ç½®Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add app/posts/*.md

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦æäº¤"
            echo "has_commits=false" >> $GITHUB_OUTPUT
          else
            # åˆ›å»ºæäº¤ä¿¡æ¯
            commit_message="è‡ªåŠ¨å¤„ç†æ–‡ç«  [skip ci]

          å¤„ç†äº† ${{ steps.extract.outputs.extracted_count }} ç¯‡æ–‡ç« 
          - æå–: ${{ steps.extract.outputs.extracted_count }} ç¯‡
          - ç¿»è¯‘: ${{ steps.translate.outputs.translated_count }} ç¯‡
          - ç”ŸæˆMarkdown: ${{ steps.generate_markdown.outputs.markdown_count }} ç¯‡

          è§¦å‘è€…: ${{ github.actor }}
          å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            # æäº¤å˜æ›´
            git commit -m "$commit_message"

            # æ¨é€åˆ°å½“å‰åˆ†æ”¯
            git push origin HEAD

            echo "âœ“ æˆåŠŸæäº¤å˜æ›´"
            echo "has_commits=true" >> $GITHUB_OUTPUT

            # è¾“å‡ºæäº¤ä¿¡æ¯
            echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      # 10. è§¦å‘Verceléƒ¨ç½²ï¼ˆé€šè¿‡webhookæˆ–ç­‰å¾…è‡ªåŠ¨éƒ¨ç½²ï¼‰
      - name: é€šçŸ¥Verceléƒ¨ç½²
        if: steps.commit.outputs.has_commits == 'true'
        continue-on-error: true
        run: |
          echo "## è§¦å‘Verceléƒ¨ç½²"

          # Vercelä¼šè‡ªåŠ¨æ£€æµ‹åˆ°Gitæ¨é€å¹¶éƒ¨ç½²
          echo "âœ“ Gitæ¨é€å·²å®Œæˆï¼ŒVercelå°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²"

          # å¦‚æœé…ç½®äº†Vercel webhookï¼Œå¯ä»¥ä¸»åŠ¨è§¦å‘
          if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            echo "è§¦å‘Verceléƒ¨ç½²webhook..."
            curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}" || {
              echo "::warning::Vercel webhookè§¦å‘å¤±è´¥ï¼Œä½†Vercelä»ä¼šè‡ªåŠ¨éƒ¨ç½²"
            }
          fi

      # 11. ç”Ÿæˆå¤„ç†æŠ¥å‘Š
      - name: ç”Ÿæˆå¤„ç†æŠ¥å‘Š
        if: always() && steps.detect_changes.outputs.has_changes == 'true'
        run: |
          echo "# ğŸ“Š æ–‡ç« å¤„ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## å¤„ç†ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "| æ­¥éª¤ | æ•°é‡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æµ‹åˆ°çš„æ–‡ç«  | ${{ steps.detect_changes.outputs.articles_count }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| æˆåŠŸæå– | ${{ steps.extract.outputs.extracted_count || 0 }} | ${{ steps.extract.outputs.extraction_success == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æˆåŠŸç¿»è¯‘ | ${{ steps.translate.outputs.translated_count || 0 }} | ${{ steps.translate.outputs.translation_success == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç”ŸæˆMarkdown | ${{ steps.generate_markdown.outputs.markdown_count || 0 }} | ${{ steps.generate_markdown.outputs.markdown_success == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.commit.outputs.has_commits }}" == "true" ]; then
            echo "## æäº¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "- æäº¤SHA: \`${{ steps.commit.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- åˆ†æ”¯: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.commit.outputs.has_commits }}" == "true" ]; then
            echo "âœ… å˜æ›´å·²æ¨é€ï¼Œç­‰å¾…Vercelè‡ªåŠ¨éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          fi

      # 12. é”™è¯¯é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: å‘é€é”™è¯¯é€šçŸ¥
        if: failure()
        continue-on-error: true
        run: |
          echo "::error::æ–‡ç« å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

          # å¦‚æœé…ç½®äº†é€šçŸ¥webhookï¼ˆå¦‚Slackã€Discordç­‰ï¼‰
          if [ -n "${{ secrets.NOTIFICATION_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.NOTIFICATION_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "âš ï¸ æ–‡ç« å¤„ç†å¤±è´¥",
                "blocks": [{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æ–‡ç« å¤„ç†å·¥ä½œæµå¤±è´¥*\nâ€¢ ä»“åº“: ${{ github.repository }}\nâ€¢ åˆ†æ”¯: ${{ github.ref_name }}\nâ€¢ è¿è¡Œè€…: ${{ github.actor }}\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|æŸ¥çœ‹è¯¦æƒ…>"
                  }
                }]
              }' || true
          fi

  # æ¸…ç†å·¥ä½œï¼ˆå¯é€‰ï¼‰
  cleanup:
    name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    runs-on: ubuntu-latest
    needs: process-articles
    if: always()
    continue-on-error: true

    steps:
      - name: æ¸…ç†å·¥ä½œæµäº§ç‰©
        run: |
          echo "æ¸…ç†å®Œæˆ"
          # GitHub Actionsä¼šè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          # è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„æ¸…ç†é€»è¾‘ï¼ˆå¦‚æ¸…ç†ç¼“å­˜ç­‰ï¼‰