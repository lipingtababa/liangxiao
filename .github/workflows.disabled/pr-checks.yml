name: PR 检查

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-gates:
    name: 代码质量门禁
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录用于比较

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
          cache: 'pip'

      - name: 安装依赖
        run: |
          npm ci
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: 检查代码格式
        run: |
          npm run lint
          npm run typecheck

      - name: 运行测试并检查覆盖率
        run: |
          npm run test:coverage
          pytest --cov=scripts --cov-fail-under=70

      - name: 检查测试覆盖率阈值
        run: |
          npx nyc check-coverage --lines 70 --functions 70 --branches 70

      - name: 评论测试覆盖率报告
        uses: ArtiomTr/jest-coverage-report-action@v2
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          threshold: 70
          skip-step: install
          coverage-file: ./coverage/coverage-final.json
          base-coverage-file: ./coverage/coverage-final.json
